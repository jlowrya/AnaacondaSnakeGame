<!DOCTYPE html>
<html>
<head>
    <title>My Snake Game</title>
</head>
<style>
    body {
        text-align: center;
    }
    .grid-container {
        align-items: center;
        display: grid;
        grid-template-columns: repeat(10, 50px);
        grid-template-rows: auto;
        background-color: black;
        /* border-style: solid; */
        width:508px;
        column-gap: 1px;
        row-gap: 1px;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
    }

    .grid-item {
        background-color: white;
        border: black;
        height: 50px;
        width: 50px;
        justify-this: center;
    }

    .snake {
        background-color: green;
    }

    .dead {
        background-color: red;
    }

    .head {
        background-color: orange;
    }

    .bun {
        background-color: burlywood;
    }

    .hidden {
            display: none;
            visibility: hidden;
    }
</style>
<body>
    <h1>Welcome to Snake-a-Conda Bun Hunter!</h1>
    <button id="start">Start Game</button>
    <br/>
    <div id="grid" class="grid-container">
    </div>
    <br/>
    <div id="score" class="hidden"></div>
    <button id="restart" class="hidden">Restart</button>

    <script>
        let gameInProgress = false;
        let numGamesPlayed = 1;
        const startButton = document.getElementById('start');

        const numColumns = 10;
        const numRows = 10;

        const startBox = 0;
        const moveDirection = 'right';

        let score = 1;

     

        function makeSnake(e){
            e.target.classList.add("snake");
        }

        function getNextCellId(oldPositionId, direction){
            switch(direction){
                case "right":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+1;
                case "left":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-1;
                case "up":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-numRows;
                case "down":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+numRows;
            }
        }

        function isOutOfBounds(newPositionId, direction){
            return newPositionId<0 || newPositionId>=numColumns*numRows || (direction==="right" && newPositionId%numColumns===0) || (direction==="left" && newPositionId%numColumns===(numColumns-1));
        }

        function getOppositeDirection(direction){
            switch(direction){
                case "up":
                    return "down";
                case "down":
                    return "up";
                case "left":
                    return "right";
                case "right":
                    return "left";
            }
        }


        function addBunToBoard(){
            let randomPosition = Math.floor(Math.random()*numColumns*numRows);
            console.log('Trying to put bun in position ', randomPosition);
            let positionDiv = document.getElementById(randomPosition);

            while(positionDiv.classList.contains('snake')){
                console.log('Position ', randomPosition, ' is occupied by the snake, recalculating...');
                randomPosition = Math.floor(Math.random()*numColumns*numRows);
                console.log('Trying to put bun in position ', randomPosition);
                positionDiv = document.getElementById(randomPosition);
            }

            positionDiv.classList.add('bun');
        }        

        document.onkeydown = function(e){
            switch(e.key){
                case "ArrowUp":
                    snake.setDirection("up");
                    break;
                case "ArrowDown":
                    snake.setDirection("down");
                    break;
                case "ArrowLeft":
                    snake.setDirection("left");
                    break; 
                case "ArrowRight":
                    snake.setDirection("right");
                    break;
            }
        }

        function resetGame(snake){
            //clear the board of all classes
            let divsToClear = document.querySelectorAll('.snake, .dead, .bun');
            for(let div of divsToClear){
                div.classList = 'grid-item';
            }
            
            snake.reset();

            addBunToBoard();
            score = 1;
            const scoreDiv = document.getElementById('score');
            scoreDiv.textContent =`Score: ${score}`;

            const newIntervalId = setInterval(()=>snake.move(), 300);

            console.log('New interval id ', newIntervalId)
        }

        class SnakeNode {
            constructor(value, nextNode, prevNode){
                this.value = value;
                this.next = nextNode;
                this.prev = prevNode;
            }
        }

        class Snake {
            constructor(head){
                this.head = head;
                this.tail = head;

                this.direction = "right";

                const position = document.getElementById(this.head.value)
                position.classList.add("snake")

                console.log('Head during initialization ', this.head)
                console.log('Tail during initialization ', this.tail)
            }

            //TODO: add prevNode logic
            append(value){
                //adds node to the end of the list
                prevTail = this.tail;
                newTail = new SnakeNode(value, null, prevTail);
                prevTail.next = newTail;
                this.tail = newTail;
                const newPosition = document.getElementById(value);
                newPosition.classList.add("snake");
            };
            
            //TODO: add prevNode logic
            prepend(value){
                //add node to the beginning of the list
                const prevHead = this.head;
                const newHead = new SnakeNode(value, prevHead, null);
                if(prevHead!==null){
                    prevHead.prev = newHead;
                }
                
                this.head = newHead;

                if(this.tail===null){
                    this.tail = this.head
                }

                const newPosition = document.getElementById(value);
                newPosition.classList.add("snake");
            };

            pop(){
                //remove the tail and return the value
                const toRemove = this.tail;
                if(toRemove.prev!==null){
                    const newTail = toRemove.prev;
                    newTail.next = null;
                    this.tail = newTail;
                } else {
                    //if linked list has length of one
                    this.head = null;
                    this.tail = null;
                }
                
                return toRemove.value;
            };

            fail(){
                let node = this.head;
                while(node){
                    let cell = document.getElementById(node.value);
                    cell.classList.remove('snake');
                    cell.classList.add('dead')
                    node = node.next;
                }
                clearInterval(numGamesPlayed);
                numGamesPlayed+=1;
            }

            setDirection(direction){
                this.direction = direction;
            }

            clear(){
                this.head = null;
                this.tail = null;
            }

            reset(){
                this.clear();
                const newHead = new SnakeNode(startBox, null, null);
                snake.head = newHead;
                snake.tail = newHead

                snake.direction = 'right';

                const position = document.getElementById(this.head.value)
                position.classList.add("snake")
            }

            move(direction){
                if(!direction){
                    direction = this.direction;
                }

                console.log('Head ', this.head)
                console.log('Tail ', this.tail)
                let newPositionId = getNextCellId(parseInt(this.head.value), this.direction);
                let newPosition = document.getElementById(newPositionId);
                //don't allow the snake to go back on itself
                if (this.head.next && newPositionId===this.head.next.value){
                    console.warn('You cannot move back on yourself')
                    this.direction = getOppositeDirection(this.direction);
                    newPositionId = getNextCellId(parseInt(this.head.value), this.direction);
                    newPosition = document.getElementById(newPositionId);
                }

                if(isOutOfBounds(newPositionId, this.direction) || newPosition.classList.contains('snake')){
                    console.warn('Attempting illegal move')
                    this.fail();
                }
                else{
                    const newPosition = document.getElementById(newPositionId);
                    let ateBun = false;
                    //if the snake eats a bun it increases its size, so leave the last element untouched
                    if(!newPosition.classList.contains('bun')){
                        const locationToRemove = this.pop()
                        console.log('Removing location ', locationToRemove)
                        const oldPosition = document.getElementById(locationToRemove)
                        oldPosition.classList.remove('snake');
                    }
                    else{
                        ateBun = true;
                        newPosition.classList.remove('bun')
                        score+=1;
                        const scoreDiv = document.getElementById('score');
                        scoreDiv.textContent =`Score: ${score}`;
                    }

                    this.prepend(newPositionId);
                    newPosition.classList.add("snake");

                    if (ateBun){
                        addBunToBoard();
                    }
                }
            }

        }

        const initialNode = new SnakeNode(startBox, null, null)
        let snake = null;

        
        startButton.addEventListener("click", ()=>{
            const grid = document.getElementById("grid");
            gameInProgress = true;

            for(let i=0; i<numColumns*numRows;i++){
            let box = document.createElement("div");
            box.id = `${i}`;
            box.classList.add('grid-item');
            grid.append(box);

            startButton.classList.add('hidden');
        }

        const resetButton = document.getElementById('restart');
        resetButton.classList.remove('hidden');

        const scoreDiv = document.getElementById('score');
        scoreDiv.classList.remove('hidden');
        scoreDiv.innerText = `Score: ${score}`;
        
        snake = new Snake(initialNode)

        addBunToBoard();

        setInterval(()=>snake.move(), 300)
        })

        const resetButton = document.getElementById('restart');
        resetButton.addEventListener('click', () => resetGame(snake));

        

    </script>
</body>
</html>
