<!DOCTYPE html>
<html>
<head>
    <title>My Snake Game</title>
</head>
<style>
    body {
        text-align: center;
    }
    .grid-container {
        align-items: center;
        display: grid;
        grid-template-columns: repeat(10, 50px);
        grid-template-rows: auto;
        background-color: black;
        /* border-style: solid; */
        width:508px;
        column-gap: 1px;
        row-gap: 1px;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
    }

    .grid-item {
        background-color: white;
        border: black;
        height: 50px;
        width: 50px;
        justify-this: center;
    }

    .snake {
        background-color: green;
    }

    .dead {
        background-color: red;
    }

    .mouse {
        background-color: grey;
    }

    .bun {
        background-color: burlywood;
    }

    .hidden {
            display: none;
            visibility: hidden;
    }

    .anaconda {
        background-color: yellow;
    }
</style>
<body>
    <audio id="audio">
        <source src="audio/anaconda.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    <h1>Welcome to Snake-a-Conda Bun Hunter!</h1>
    <button id="start">Start Game</button>
    <br/>
    <div id="grid" class="grid-container">
    </div>
    <br/>
    <div id="score" class="hidden"></div><div id="bunCount" class="hidden"></div>
    <button id="restart" class="hidden">Restart</button>

    <script>
        let gameInProgress = false;
        let numGamesPlayed = 1;
        const bunsNeededForAnaconda = 15;
        const startButton = document.getElementById('start');

        const numColumns = 10;
        const numRows = 10;

        const startBox = 0;
        const moveDirection = 'right';

        let segmentEnd = 1.5;

        let score = 1;

        const audio = document.getElementById('audio');

        // audio.addEventListener('timeupdate', ()=>{
        //     if(audio.currentTime>=segmentEnd){
        //         audio.pause();
        //         audio.currentTime = 0;
        //     }
        // })

     

        function makeSnake(e){
            e.target.classList.add("snake");
        }

        function getNextCellId(oldPositionId, direction){
            switch(direction){
                case "right":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+1;
                case "left":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-1;
                case "up":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-numRows;
                case "down":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+numRows;
            }
        }

        function isOutOfBounds(newPositionId, direction){
            return newPositionId<0 || newPositionId>=numColumns*numRows || (direction==="right" && newPositionId%numColumns===0) || (direction==="left" && newPositionId%numColumns===(numColumns-1));
        }

        function getOppositeDirection(direction){
            switch(direction){
                case "up":
                    return "down";
                case "down":
                    return "up";
                case "left":
                    return "right";
                case "right":
                    return "left";
            }
        }

        function spaceIsOccupied(cellId){
            return document.getElementById(cellId).classList.length>1 ? document.getElementById(cellId).classList[1] : null;
        }

        function addItemToBoard(itemToAdd, cellId){
            document.getElementById(cellId).classList.add(itemToAdd);
        }

        function randomAddItemToBoard(itemToAdd){
            let randomPosition = Math.floor(Math.random()*numColumns*numRows);

            while(spaceIsOccupied(randomPosition)){
                randomPosition = Math.floor(Math.random()*numColumns*numRows);
            }

            addItemToBoard(itemToAdd, randomPosition);
        }

        function removeItemAtPosition(cellId){
            console.log('Removing location ', cellId)
            document.getElementById(cellId).classList = document.getElementById(cellId).classList[0];
        }
        
        function oppositeWallPosition(cellId, direction){
            switch(direction){
                case "up":
                    return Math.abs(cellId+numColumns*numRows);
                case "down":
                    return cellId-numRows*numColumns;
                case "left":
                    return cellId+numColumns;
                case "right":
                    return cellId-numColumns;
            }
        }

        document.onkeydown = function(e){
            switch(e.key){
                case "ArrowUp":
                    snake.setDirection("up");
                    break;
                case "ArrowDown":
                    snake.setDirection("down");
                    break;
                case "ArrowLeft":
                    snake.setDirection("left");
                    break; 
                case "ArrowRight":
                    snake.setDirection("right");
                    break;
            }
        }

        function resetGame(snake){
            //clear the board of all classes
            let divsToClear = document.querySelectorAll('.snake, .dead, .bun, .anaconda');
            for(let div of divsToClear){
                div.classList = 'grid-item';
            }
            
            snake.reset();

            randomAddItemToBoard('bun');
            score = 1;
            const scoreDiv = document.getElementById('score');
            scoreDiv.textContent =`Score: ${score}`;

            const bunDiv = document.getElementById('bunCount');
            bunDiv.textContent =`Buns: ${snake.bunsEaten}`;
            
            clearInterval(numGamesPlayed);
            numGamesPlayed+=1;

            setInterval(()=>snake.move(), 300);
        }

        // function playSound(){
        //     audio.currentTime = 0;
        //     audio.play()
        //     setInterval()
        // }

        class SnakeNode {
            constructor(value, nextNode, prevNode){
                this.value = value;
                this.next = nextNode;
                this.prev = prevNode;
            }
        }

        class Snake {
            constructor(head){
                this.head = head;
                this.tail = head;

                this.bunsEaten = 14;

                this.direction = "right";
                this.isAnaconda = false;
                this.timesAnaconda = 0;

                this.audioIntervalId;

                const position = document.getElementById(this.head.value)
                position.classList.add(this.class)
            }

            get class() {
                return this.isAnaconda ? "anaconda" : "snake";
            }

            toggleAnaconda(){
                this.isAnaconda = !this.isAnaconda;
                
                let classToRemove, classToAdd;
                
                [classToRemove, classToAdd] = this.isAnaconda ? ['snake', 'anaconda'] : ['anaconda', 'snake'];

                let snakePiece = this.head;
                while(snakePiece.next){
                    const toChange = document.getElementById(snakePiece.value);
                    toChange.classList.remove(classToRemove);
                    toChange.classList.add(classToAdd);
                    snakePiece = snakePiece.next;
                }

                if(this.isAnaconda){
                    audio.play();
                    this.timesAnaconda+=1;
                    this.audioIntervalId = setInterval(()=>{
                        audio.pause();
                        this.toggleAnaconda();   
                    },15000)
                }
                else{
                    clearInterval(this.audioIntervalId);
                }
            }

            append(value){
                //adds node to the end of the list
                prevTail = this.tail;
                newTail = new SnakeNode(value, null, prevTail);
                prevTail.next = newTail;
                this.tail = newTail;
                const newPosition = document.getElementById(value);
                newPosition.classList.add(this.class);
            };
            
            prepend(value){
                //add node to the beginning of the list
                const prevHead = this.head;
                const newHead = new SnakeNode(value, prevHead, null);
                if(prevHead!==null){
                    prevHead.prev = newHead;
                }
                
                this.head = newHead;

                if(this.tail===null){
                    this.tail = this.head
                }

                const newPosition = document.getElementById(value);
                newPosition.classList.add(this.class);
            };

            pop(){
                //remove the tail and return the value
                const toRemove = this.tail;
                if(toRemove.prev!==null){
                    const newTail = toRemove.prev;
                    newTail.next = null;
                    this.tail = newTail;
                } else {
                    //if linked list has length of one
                    this.head = null;
                    this.tail = null;
                }
                
                return toRemove.value;
            };

            fail(){
                let node = this.head;
                while(node){
                    let cell = document.getElementById(node.value);
                    cell.classList.remove(this.class);
                    cell.classList.add('dead');
                    node = node.next;
                }
                clearInterval(numGamesPlayed);
                numGamesPlayed+=1;
                audio.pause()
            }

            setDirection(direction){
                this.direction = direction;
            }

            clear(){
                this.head = null;
                this.tail = null;
            }

            reset(){
                this.clear();
                const newHead = new SnakeNode(startBox, null, null);
                this.head = newHead;
                this.tail = newHead

                this.direction = 'right';
                this.bunsEaten = 0;
                this.isAnaconda = false;

                const position = document.getElementById(this.head.value)
                position.classList.add(this.class)
            }

            eatSelf(positionId){
                let lastRemoved = this.pop()
                while(lastRemoved!=positionId){
                    removeItemAtPosition(lastRemoved);
                    lastRemoved = this.pop();
                }
                removeItemAtPosition(lastRemoved);
            }

            move(direction){
                if(!direction){
                    direction = this.direction;
                }

                let newPositionId = getNextCellId(parseInt(this.head.value), this.direction);
                let newPosition = document.getElementById(newPositionId);
                //don't allow the snake to go back on itself
                if (this.head.next && newPositionId===this.head.next.value){
                    console.warn('You cannot move back on yourself')
                    this.direction = getOppositeDirection(this.direction);
                    newPositionId = getNextCellId(parseInt(this.head.value), this.direction);
                    newPosition = document.getElementById(newPositionId);
                }

                if(isOutOfBounds(newPositionId, this.direction) || newPosition.classList.contains(this.class)){
                    if(this.isAnaconda){
                        //if it's an anaconda, allow to pass through wall and continue to opposite side
                        if(isOutOfBounds(newPositionId, this.direction)){
                            console.log('Out of bounds while anaconda')
                            newPositionId = oppositeWallPosition(newPositionId, this.direction);
                            console.log('New pos id on opposite wall is ', newPositionId);
                        }
                        if(spaceIsOccupied(newPositionId)===this.class){
                            this.eatSelf(newPositionId);
                        }
                        removeItemAtPosition(this.pop());
                        this.prepend(newPositionId);
                        addItemToBoard(this.class, newPositionId);
                    }
                    else{
                        console.warn('Attempting illegal move')
                        this.fail();
                    }
                    
                }
                else{
                    let shouldRemoveSnakePiece = true;
                    let thingToEat = spaceIsOccupied(newPositionId);
                    console.log('Thing to eat is ', thingToEat)
                    switch(thingToEat){
                        case null:
                            console.warn('Nothing to eat, breaking out swtich statement');
                            break;
                        case 'mouse':
                            console.warn('In mouse switch case');
                            score+=1;
                            const scoreDiv = document.getElementById('score');
                            scoreDiv.textContent =`Score: ${score}`;
                            shouldRemoveSnakePiece = false;
                            randomAddItemToBoard('mouse');
                            break;
                        case 'bun':
                            console.warn('In bun switch case');
                            this.bunsEaten+=1;
                            const bunDiv = document.getElementById('bunCount');
                            bunDiv.textContent =`Buns: ${this.bunsEaten}`;
                            randomAddItemToBoard('bun');
                            if(this.bunsEaten%bunsNeededForAnaconda===0){
                                console.log('toggling anaconda');
                                this.toggleAnaconda();
                                
                            }
                            break;
                    }

                    removeItemAtPosition(newPositionId);

                    //if the snake eats a bun it increases its size, so leave the last element untouched
                    if(shouldRemoveSnakePiece){
                        removeItemAtPosition(this.pop());
                    }

                    this.prepend(newPositionId);
                    addItemToBoard(this.class, newPositionId);
                }
            }

        }

        const initialNode = new SnakeNode(startBox, null, null)
        let snake = null;

        
        startButton.addEventListener("click", ()=>{
            const grid = document.getElementById("grid");
            gameInProgress = true;

            for(let i=0; i<numColumns*numRows;i++){
            let box = document.createElement("div");
            box.id = `${i}`;
            box.classList.add('grid-item');
            grid.append(box);

            startButton.classList.add('hidden');
        }

        const resetButton = document.getElementById('restart');
        resetButton.classList.remove('hidden');

        const scoreDiv = document.getElementById('score');
        scoreDiv.classList.remove('hidden');
        scoreDiv.innerText = `Score: ${score}`;

        
        
        snake = new Snake(initialNode)

        const bunDiv = document.getElementById('bunCount');
        bunDiv.classList.remove('hidden');
        bunDiv.innerText = `Buns: ${snake.bunsEaten}`;

        randomAddItemToBoard('bun');
        randomAddItemToBoard('mouse');

        setInterval(()=>snake.move(), 300)
        })

        const resetButton = document.getElementById('restart');
        resetButton.addEventListener('click', () => resetGame(snake));

        

    </script>
</body>
</html>
