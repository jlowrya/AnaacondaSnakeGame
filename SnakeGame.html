<!DOCTYPE html>
<html>
<head>
    <title>My Snake Game</title>
</head>
<style>
    .grid-container {
        align-items: center;
        display: grid;
        grid-template-columns: repeat(10, 50px);
        grid-template-rows: auto;
        background-color: black;
        border-style: solid;
        width:508px;
        column-gap: 1px;
        row-gap: 1px;
    }

    .grid-item {
        background-color: white;
        border: black;
        height: 50px;
        width: 50px;
        justify-this: center;
    }

    .snake {
        background-color: green;
    }

    .dead {
        background-color: red;
    }

    .head {
        background-color: orange;
    }

    .bun {
        background-color: burlywood;
    }
</style>
<body>
    <h1>Welcome to Snake Game!</h1>
    <div id="grid" class="grid-container">
    </div>

    <script>
        const numColumns = 10;
        const numRows = 10;

        const startBox = 0;
        const moveDirection = 'right'

        const grid = document.getElementById("grid");

        function makeSnake(e){
            e.target.classList.add("snake");
        }

        function getNextCellId(oldPositionId, direction){
            switch(direction){
                case "right":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+1;
                case "left":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-1;
                case "up":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId-numRows;
                case "down":
                    console.log("Getting next id for direction ", direction);
                    return oldPositionId+numRows;
            }
        }

        function isOutOfBounds(newPositionId, direction){
            return newPositionId<0 || newPositionId>=numColumns*numRows || (direction==="right" && newPositionId%numColumns===0) || (direction==="left" && newPositionId%numColumns===(numColumns-1));
        }


        function addBunToBoard(){
            let randomPosition = Math.floor(Math.random()*numColumns*numRows);
            console.log('Trying to put bun in position ', randomPosition);
            let positionDiv = document.getElementById(randomPosition);

            while(positionDiv.classList.contains('snake')){
                console.log('Position ', randomPosition, ' is occupied by the snake, recalculating...');
                randomPosition = Math.floor(Math.random()*numColumns*numRows);
                console.log('Trying to put bun in position ', randomPosition);
                positionDiv = document.getElementById(randomPosition);
            }

            positionDiv.classList.add('bun');
        }


        for(let i=0; i<numColumns*numRows;i++){
            let box = document.createElement("div");
            box.id = `${i}`;
            box.classList.add('grid-item');
            grid.append(box);
        }        

        document.onkeydown = function(e){
            switch(e.key){
                case "ArrowUp":
                    snake.setDirection("up");
                    break;
                case "ArrowDown":
                    snake.setDirection("down");
                    break;
                case "ArrowLeft":
                    snake.setDirection("left");
                    break; 
                case "ArrowRight":
                    snake.setDirection("right");
                    break;
            }
        }

        class SnakeNode {
            constructor(value, nextNode, prevNode){
                this.value = value;
                this.next = nextNode;
                this.prev = prevNode;
            }
        }

        class Snake {
            constructor(head){
                this.head = head;
                this.tail = head;

                this.direction = "right";

                const position = document.getElementById(this.head.value)
                position.classList.add("snake")

                console.log('Head during initialization ', this.head)
                console.log('Tail during initialization ', this.tail)
            }

            //TODO: add prevNode logic
            append(value){
                //adds node to the end of the list
                prevTail = this.tail;
                newTail = new SnakeNode(value, null, prevTail);
                prevTail.next = newTail;
                this.tail = newTail;
                const newPosition = document.getElementById(value);
                newPosition.classList.add("snake");
            };
            
            //TODO: add prevNode logic
            prepend(value){
                //add node to the beginning of the list
                const prevHead = this.head;
                const newHead = new SnakeNode(value, prevHead, null);
                if(prevHead!==null){
                    prevHead.prev = newHead;
                }
                
                this.head = newHead;

                if(this.tail===null){
                    this.tail = this.head
                }

                const newPosition = document.getElementById(value);
                newPosition.classList.add("snake");
            };

            pop(){
                //remove the tail and return the value
                const toRemove = this.tail;
                if(toRemove.prev!==null){
                    const newTail = toRemove.prev;
                    newTail.next = null;
                    this.tail = newTail;
                } else {
                    //if linked list has length of one
                    this.head = null;
                    this.tail = null;
                }
                
                return toRemove.value;
            };

            setDirection(direction){
                this.direction = direction;
            }

            move(direction){
                if(!direction){
                    direction = this.direction;
                }

                console.log('Head ', this.head)
                console.log('Tail ', this.tail)
                const newPositionId = getNextCellId(parseInt(this.head.value), this.direction);
                

                if(isOutOfBounds(newPositionId, this.direction)){
                    console.warn('Attempting illegal move')
                    let node = this.head;
                    console.debug(node)
                    while(node){
                        let cell = document.getElementById(node.value);
                        cell.classList.remove('snake');
                        cell.classList.add('dead')
                        node = node.next;
                    }
                    clearInterval(1);
                }
                else{
                    const newPosition = document.getElementById(newPositionId);
                    let ateBun = false;
                    //if the snake eats a bun it increases its size, so leave the last element untouched
                    if(!newPosition.classList.contains('bun')){
                        const locationToRemove = this.pop()
                        console.log('Removing location ', locationToRemove)
                        const oldPosition = document.getElementById(locationToRemove)
                        oldPosition.classList.remove('snake');
                    }
                    else{
                        ateBun = true;
                        newPosition.classList.remove('bun')
                    }

                    this.prepend(newPositionId);
                    newPosition.classList.add("snake");

                    if (ateBun){
                        addBunToBoard();
                    }
                }
            }

        }

        const initialNode = new SnakeNode(startBox, null, null)
        const snake = new Snake(initialNode)

        addBunToBoard();

        setInterval(()=>snake.move(), 500)




        

    </script>
</body>
</html>
